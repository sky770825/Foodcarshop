# 📸 商品圖片與庫存顯示完整說明

## 🎯 數據流程

```
Google Sheets (G 欄圖片網址)
  ↓
後端 API (getInventory)
  ↓
前端 JavaScript
  ↓
顯示商品卡片（圖片 + 庫存）
```

---

## 📊 後端返回的數據結構

### **API 端點**
```
GET /exec?action=getInventory&venue=venue_a
```

### **返回數據格式**
```javascript
{
  "ok": true,
  "inventory": {
    "六蒜包": {
      "type": "main",
      "stock": 10,           // ⭐ 當前庫存
      "initialStock": 20,    // 初始庫存
      "available": true,
      "status": "正常",
      "category": "主食",
      "imageUrl": "https://..." // ⭐ 從 G 欄讀取的圖片
    },
    "丹麥手撕包": { ... }
  },
  "products": [              // ⭐ 商品列表（供前端顯示）
    {
      "name": "六蒜包",
      "img": "https://...",         // ⭐ 圖片網址
      "imageUrl": "https://...",    // ⭐ 圖片網址（重複，兼容性）
      "price": 20,                  // ⭐ 價格
      "stock": 10,                  // ⭐ 當前庫存
      "available": true             // ⭐ 是否可購買
    },
    { ... }
  ],
  "mainItems": [ ... ],      // 主餐列表（向後兼容）
  "categories": { ... },     // 配菜分類
  "timestamp": "2025-10-19T..."
}
```

---

## 🖼️ 前端如何顯示圖片

### **代碼位置**：`index.html` 第 1701-1752 行

### **關鍵函數**：`generateProducts(items)`

```javascript
function generateProducts(items) {
  items.forEach(item => {
    // ✅ 優先使用 imageUrl，其次 img，最後使用預設圖片
    const imageUrl = item.imageUrl || item.img || '預設圖片網址';
    const price = item.price || 0;
    
    // 生成商品卡片
    card.innerHTML = `
      <div class="product-image-wrap">
        <img 
          src="${imageUrl}"           // ⭐ 這裡顯示圖片
          alt="${item.name}" 
          class="product-image" 
        />
      </div>
      <div class="product-name">${item.name}</div>
      <div class="product-stock">載入中...</div>  // ⭐ 庫存稍後更新
      <div class="product-price">$${price}</div>
    `;
  });
}
```

---

## 📦 前端如何顯示庫存

### **代碼位置**：`index.html` 第 1641-1707 行

### **關鍵函數**：`updateStockStatus()`

```javascript
function updateStockStatus(forceUpdate = false) {
  document.querySelectorAll('#products .product-card').forEach(card => {
    const input = card.querySelector('input.qty');
    const itemName = input?.dataset.name;
    const stockEl = card.querySelector('.product-stock');  // ⭐ 庫存顯示元素
    
    if (itemName && INVENTORY[itemName]) {
      const stock = INVENTORY[itemName];
      
      // ⭐ 更新庫存顯示
      const current = stock.stock || 0;          // 當前庫存
      const initial = stock.initialStock || 0;   // 初始庫存
      
      // 根據庫存量設置顏色
      const stockColor = current === 0 
        ? 'var(--danger)'      // 紅色：缺貨
        : (current <= initial * 0.3 
          ? 'var(--accent)'    // 橙色：庫存低
          : 'var(--success)'); // 綠色：庫存充足
      
      stockEl.innerHTML = `庫存 <span style="color:${stockColor}; font-weight:600;">(${current}/${initial})</span>`;
    }
  });
}
```

---

## ✅ 完整數據流程圖

```
1. 用戶選擇場地（venue_a）
   ↓
2. 前端調用 API：
   GET /exec?action=getInventory&venue=venue_a
   ↓
3. 後端從 Google Sheets 讀取：
   - venue_a_庫存管理 工作表
   - A 欄：商品名稱
   - G 欄：圖片網址 ⭐
   - C 欄：當前庫存 ⭐
   - D 欄：初始庫存 ⭐
   ↓
4. 後端返回 JSON：
   {
     "products": [
       {
         "name": "六蒜包",
         "img": "https://...",      ⭐ 從 G 欄讀取
         "imageUrl": "https://...", ⭐ 從 G 欄讀取
         "price": 20,
         "stock": 10,               ⭐ 從 C 欄讀取
         "available": true
       }
     ],
     "inventory": {
       "六蒜包": {
         "stock": 10,               ⭐ 從 C 欄讀取
         "initialStock": 20,        ⭐ 從 D 欄讀取
         "imageUrl": "https://..."  ⭐ 從 G 欄讀取
       }
     }
   }
   ↓
5. 前端處理數據：
   - 將 products 儲存到 PRODUCTS 變數
   - 將 inventory 儲存到 INVENTORY 變數
   ↓
6. 前端生成商品卡片：
   - generateProducts(PRODUCTS)
   - 顯示圖片（從 item.imageUrl）
   - 顯示價格（從 item.price）
   ↓
7. 前端更新庫存顯示：
   - updateStockStatus()
   - 從 INVENTORY 讀取庫存數量
   - 顯示：庫存 (10/20)
```

---

## 🔍 故障排查

### **問題 1：圖片沒有顯示**

**可能原因：**
1. ✅ 後端沒有讀取 G 欄的圖片網址
2. ✅ G 欄的圖片網址為空
3. ✅ 圖片網址格式不正確

**檢查方法：**
```javascript
// 在瀏覽器控制台執行
console.log(PRODUCTS);

// 預期輸出：
[
  {
    "name": "六蒜包",
    "img": "https://...",      // ⭐ 應該有圖片網址
    "imageUrl": "https://...", // ⭐ 應該有圖片網址
    "price": 20,
    "stock": 10
  }
]
```

**解決方法：**
1. 確認 Google Sheets 的 G 欄有填入圖片網址
2. 確認圖片網址是完整的 URL（以 `https://` 開頭）
3. 確認後端代碼正確讀取 G 欄（第 6 個欄位，索引為 6）

---

### **問題 2：庫存顯示「載入中...」不更新**

**可能原因：**
1. ✅ INVENTORY 變數為空
2. ✅ updateStockStatus() 沒有被調用
3. ✅ 商品名稱不匹配

**檢查方法：**
```javascript
// 在瀏覽器控制台執行
console.log(INVENTORY);

// 預期輸出：
{
  "六蒜包": {
    "stock": 10,
    "initialStock": 20,
    "imageUrl": "https://..."
  }
}
```

**解決方法：**
1. 確認後端 API 返回了 `inventory` 字段
2. 確認前端正確儲存了 `INVENTORY = data.inventory`
3. 確認商品名稱完全一致（大小寫、空格）

---

### **問題 3：圖片載入失敗（顯示破圖）**

**可能原因：**
1. ✅ 圖片網址無效或已失效
2. ✅ 圖片網址需要登入才能訪問
3. ✅ 圖片網址被防盜鏈保護

**解決方法：**
1. 使用公開的圖片托管服務（如：Imgur, PostImage, Unsplash）
2. 確認圖片網址可以直接在瀏覽器中打開
3. 使用 `onerror` 屬性顯示備用圖片（前端已實現）

---

## 🛠️ 後端代碼確認

### **讀取 G 欄圖片**（Google_Apps_Script_後端_多場地版.js 第 466-472 行）

```javascript
// 從第2行開始（跳過標題）
// 欄位：A=商品名稱, B=類型, C=當前庫存, D=初始庫存, E=狀態, F=分類, G=圖片網址
for (let i = 1; i < data.length; i++) {
  const [name, type, currentStock, initialStock, status, category, imageUrl] = data[i];
  //                                                                           ↑
  //                                                                    第 7 個欄位 = G 欄
  
  if (!name) continue;
  
  // 📸 直接使用工作表 G 欄的图片网址
  const finalImageUrl = imageUrl || '';  // ⭐ 從 G 欄讀取
  
  inventory[name] = {
    type: type,
    stock: currentStock || 0,
    initialStock: initialStock || 0,
    available: (currentStock || 0) > 0,
    status: status || '正常',
    category: category || '其他',
    imageUrl: finalImageUrl  // ⭐ 儲存圖片網址
  };
}
```

### **返回 products 列表**（第 536-544 行）

```javascript
// 🆕 生成 products 列表（包含價格）
const products = mainItems.map(item => ({
  name: item.name,
  img: item.imageUrl,         // ⭐ 圖片網址
  imageUrl: item.imageUrl,    // ⭐ 圖片網址（重複，兼容性）
  price: 20,                  // ⭐ 價格
  stock: item.stock,          // ⭐ 庫存
  available: item.available   // ⭐ 是否可購買
}));

return jsonResponse({
  ok: true,
  inventory: inventory,       // ⭐ 完整的庫存資料
  categories: categories,
  mainItems: mainItems,
  products: products,         // ⭐ 商品列表（供前端顯示）
  timestamp: new Date().toISOString()
});
```

---

## 📝 Google Sheets 工作表結構

### **場地庫存工作表**（例如：`venue_a_庫存管理`）

| A 欄 | B 欄 | C 欄 | D 欄 | E 欄 | F 欄 | G 欄 ⭐ |
|------|------|------|------|------|------|---------|
| 商品名稱 | 類型 | 當前庫存 | 初始庫存 | 狀態 | 分類 | **圖片網址** |
| 六蒜包 | main | 10 | 20 | 正常 | 主食 | `https://i.postimg.cc/xxx/xxx.jpg` |
| 丹麥手撕包 | main | 8 | 15 | 正常 | 主食 | `https://i.postimg.cc/yyy/yyy.jpg` |

⚠️ **重要：G 欄必須填入完整的圖片網址（以 `https://` 開頭）**

---

## ✅ 測試步驟

### **Step 1: 測試後端 API**

在瀏覽器訪問：
```
https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?action=getInventory&venue=venue_a
```

**檢查返回的 JSON：**
```json
{
  "ok": true,
  "products": [
    {
      "name": "六蒜包",
      "img": "https://...",      // ✅ 應該有圖片網址
      "imageUrl": "https://...", // ✅ 應該有圖片網址
      "price": 20,
      "stock": 10                // ✅ 應該有庫存數量
    }
  ]
}
```

---

### **Step 2: 測試前端顯示**

1. 打開 `index.html`
2. 打開瀏覽器控制台（F12）
3. 選擇取餐場地
4. 執行以下命令檢查數據：

```javascript
// 檢查商品列表
console.log('商品列表:', PRODUCTS);

// 檢查庫存資料
console.log('庫存資料:', INVENTORY);

// 檢查圖片網址
PRODUCTS.forEach(item => {
  console.log(`${item.name} 圖片:`, item.imageUrl || item.img);
});
```

---

### **Step 3: 檢查圖片是否正確顯示**

1. 查看商品卡片是否顯示圖片
2. 如果顯示破圖，右鍵點擊圖片 → 在新分頁開啟
3. 確認圖片網址是否有效

---

### **Step 4: 檢查庫存是否正確顯示**

1. 查看商品卡片下方是否顯示「庫存 (10/20)」
2. 如果顯示「載入中...」，檢查控制台的 `INVENTORY` 變數
3. 確認商品名稱完全一致

---

## 🚀 推薦的圖片托管服務

### **1. PostImage** ⭐ 推薦
- 網址：https://postimages.org/
- 特點：免費、無需登入、支援直連
- 上傳後複製「Direct Link」

### **2. Imgur**
- 網址：https://imgur.com/
- 特點：免費、支援大流量
- 上傳後複製圖片網址

### **3. Unsplash**（預設使用）
- 網址：https://unsplash.com/
- 特點：免費高品質圖片庫
- 網址格式：`https://images.unsplash.com/photo-xxx?w=400&h=400`

---

## 📞 技術支援

如有問題，請提供以下資訊：
1. 瀏覽器控制台的錯誤訊息
2. API 返回的 JSON 數據
3. Google Sheets 的 G 欄內容截圖

聯繫：**快閃餐車小幫手**  
LINE: https://lin.ee/YyXagFg

---

## 📊 數據流程總結

```
Google Sheets G 欄
  ↓
後端讀取 imageUrl
  ↓
返回 products.imageUrl
  ↓
前端 generateProducts()
  ↓
顯示 <img src="imageUrl">
  ↓
✅ 圖片顯示成功

Google Sheets C 欄
  ↓
後端讀取 currentStock
  ↓
返回 inventory.stock
  ↓
前端 updateStockStatus()
  ↓
顯示「庫存 (10/20)」
  ↓
✅ 庫存顯示成功
```

---

© 2025 快閃餐車小幫手 · 技術文件

