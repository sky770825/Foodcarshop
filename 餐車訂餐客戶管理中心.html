<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä È§êËªäÂÆ¢Êà∂ÁÆ°ÁêÜ‰∏≠ÂøÉ PRO</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #1a1a1a;
    }
    
    .header {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      color: #1a1a1a;
      padding: 30px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .header h1 {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .header p {
      color: #6b7280;
      font-size: 14px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .stat-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 800;
      color: #1a1a1a;
      line-height: 1;
    }
    
    .stat-card.success .stat-value { color: #059669; }
    .stat-card.danger .stat-value { color: #dc2626; }
    .stat-card.warning .stat-value { color: #f59e0b; }
    .stat-card.primary .stat-value { color: #667eea; }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .search-box {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 15px;
      margin-bottom: 16px;
      transition: all 0.2s;
    }
    
    .search-box:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .client-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .client-table th {
      background: #f9fafb;
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
      font-size: 13px;
    }
    
    .client-table td {
      padding: 12px 8px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 13px;
    }
    
    .client-table tr:hover {
      background: #f9fafb;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .badge.active {
      background: #d1fae5;
      color: #065f46;
    }
    
    .badge.inactive {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .badge.warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin: 0 2px;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: #059669;
      color: white;
    }
    
    .btn-success:hover {
      background: #047857;
    }
    
    .btn-danger {
      background: #dc2626;
      color: white;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    .btn-warning {
      background: #f59e0b;
      color: white;
    }
    
    .btn-warning:hover {
      background: #d97706;
    }
    
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    
    .btn-secondary:hover {
      background: #e5e7eb;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    
    .loading-icon {
      font-size: 48px;
      animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .alert.warning {
      background: #fef3c7;
      color: #92400e;
      border: 2px solid #fbbf24;
    }
    
    .alert.success {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #059669;
    }
    
    .filter-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .filter-tab {
      padding: 8px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .filter-tab:hover {
      border-color: #667eea;
    }
    
    .filter-tab.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .refresh-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .refresh-btn:hover {
      transform: scale(1.1);
    }
    
    /* ÂΩàÁ™óÊ®£Âºè */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }
    
    .close-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: #f3f4f6;
      color: #6b7280;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .close-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 14px;
      color: #374151;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
    
    .modal-footer .btn {
      flex: 1;
      padding: 12px;
      font-size: 14px;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      z-index: 10000;
      animation: slideInRight 0.3s ease;
      max-width: 400px;
    }
    
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .notification.success {
      background: #059669;
      color: white;
    }
    
    .notification.error {
      background: #dc2626;
      color: white;
    }
    
    @media (max-width: 768px) {
      .client-table {
        font-size: 11px;
      }
      
      .client-table th,
      .client-table td {
        padding: 6px 4px;
      }
      
      .btn {
        padding: 4px 8px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>üìä È§êËªäÂÆ¢Êà∂ÁÆ°ÁêÜ‰∏≠ÂøÉ PRO</h1>
    <p>ÂÆåÊï¥ÊéßÂà∂ ¬∑ Âç≥ÊôÇÊìç‰Ωú ¬∑ ÊïàÁéáÁÆ°ÁêÜ</p>
  </div>
  
  <!-- Áµ±Ë®àÂç°Áâá -->
  <div class="stats-grid" id="statsGrid">
    <div class="stat-card primary" onclick="filterClients('all')">
      <div class="stat-icon">üë•</div>
      <div class="stat-label">Á∏ΩÂÆ¢Êà∂Êï∏</div>
      <div class="stat-value" id="totalClients">-</div>
    </div>
    
    <div class="stat-card success" onclick="filterClients('active')">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-label">ÂïüÁî®‰∏≠</div>
      <div class="stat-value" id="activeClients">-</div>
    </div>
    
    <div class="stat-card danger" onclick="filterClients('inactive')">
      <div class="stat-icon">üîí</div>
      <div class="stat-label">Â∑≤ÂÅúÁî®</div>
      <div class="stat-value" id="inactiveClients">-</div>
    </div>
    
    <div class="stat-card warning">
      <div class="stat-icon">üí∞</div>
      <div class="stat-label">Êú¨ÊúàÊî∂ÂÖ•</div>
      <div class="stat-value" id="monthlyRevenue">-</div>
    </div>
  </div>
  
  <!-- Âç≥Â∞áÂà∞ÊúüË≠¶Âëä -->
  <div id="expiringAlert" style="display: none;"></div>
  <div id="globalAlert" style="display: none;"></div>
  
  <!-- ÂÆ¢Êà∂ÂàóË°® -->
  <div class="card">
    <div class="card-title">
      <span>üìã ÂÆ¢Êà∂ÂàóË°®</span>
      <button class="btn btn-primary" onclick="loadClients()" style="padding:8px 16px;">
        üîÑ Âà∑Êñ∞Ë≥áÊñô
      </button>
    </div>
    
    <!-- ÊêúÂ∞ãÊ°Ü -->
    <input 
      type="text" 
      class="search-box" 
      id="searchBox" 
      placeholder="üîç ÊêúÂ∞ãÂÆ¢Êà∂ÂêçÁ®±„ÄÅÁ∂≤Á´ôID„ÄÅËÅØÁµ°‰∫∫..."
    >
    
    <!-- ÁØ©ÈÅ∏Ê®ôÁ±§ -->
    <div class="filter-tabs">
      <div class="filter-tab active" data-filter="all">ÂÖ®ÈÉ®ÂÆ¢Êà∂</div>
      <div class="filter-tab" data-filter="active">‚úÖ ÂïüÁî®‰∏≠</div>
      <div class="filter-tab" data-filter="inactive">üîí Â∑≤ÂÅúÁî®</div>
      <div class="filter-tab" data-filter="expiring">‚ö†Ô∏è Âç≥Â∞áÂà∞Êúü</div>
      <div class="filter-tab" data-filter="trial">üéÅ Ë©¶Áî®Êúü</div>
    </div>
    
    <!-- ÂÆ¢Êà∂Ë°®Ê†º -->
    <div id="tableContainer">
      <div class="loading">
        <div class="loading-icon">‚è≥</div>
        <div>ËºâÂÖ•‰∏≠...</div>
      </div>
    </div>
  </div>
  
  <!-- Á∫åË≤ªÂΩàÁ™ó -->
  <div class="modal" id="renewModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üí∞ Âø´ÈÄüÁ∫åË≤ª</div>
        <button class="close-btn" onclick="closeModal('renewModal')">√ó</button>
      </div>
      
      <div style="background:#f9fafb; padding:16px; border-radius:8px; margin-bottom:20px;">
        <div style="font-size:13px; color:#6b7280; margin-bottom:4px;">ÂÆ¢Êà∂Ë≥áË®ä</div>
        <div style="font-size:18px; font-weight:700;" id="renewClientName">-</div>
        <div style="font-size:13px; color:#9ca3af; margin-top:4px;" id="renewClientId">-</div>
      </div>
      
      <div class="form-group">
        <label class="form-label">üìÖ Áï∂ÂâçÂà∞ÊúüÊó•Êúü</label>
        <input type="text" class="form-input" id="renewCurrentExpire" readonly style="background:#f3f4f6;">
      </div>
      
      <div class="form-group">
        <label class="form-label">üí≥ Á∫åË≤ªÊñπÊ°à <span style="color:#dc2626">*</span></label>
        <select class="form-select" id="renewPlan">
          <option value="">Ë´ãÈÅ∏Êìá...</option>
          <option value="ÊúàÁπ≥">ÊúàÁπ≥ - 600ÂÖÉÔºàÂª∂Èï∑30Â§©Ôºâ</option>
          <option value="Â≠£Áπ≥">Â≠£Áπ≥ - 1440ÂÖÉÔºàÂª∂Èï∑90Â§©Ôºâ</option>
          <option value="ÂçäÂπ¥Áπ≥">ÂçäÂπ¥Áπ≥ - 2880ÂÖÉÔºàÂª∂Èï∑180Â§©Ôºâ</option>
          <option value="Âπ¥Áπ≥">Âπ¥Áπ≥ - 5400ÂÖÉÔºàÂª∂Èï∑365Â§©Ôºâ</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">üìÖ Á∫åË≤ªÂæåÂà∞ÊúüÊó•Êúü</label>
        <input type="text" class="form-input" id="renewNewExpire" readonly style="background:#f9fafb; color:#059669; font-weight:600;">
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('renewModal')">ÂèñÊ∂à</button>
        <button class="btn btn-success" onclick="confirmRenew()" id="confirmRenewBtn">‚úì Á¢∫Ë™çÁ∫åË≤ª</button>
      </div>
    </div>
  </div>
  
  <!-- Á∑®ËºØÂΩàÁ™ó -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">‚úèÔ∏è Á∑®ËºØÂÆ¢Êà∂Ë≥áË®ä</div>
        <button class="close-btn" onclick="closeModal('editModal')">√ó</button>
      </div>
      
      <input type="hidden" id="editWebsiteId">
      
      <div class="form-group">
        <label class="form-label">üè™ ÂïÜÂÆ∂ÂêçÁ®±</label>
        <input type="text" class="form-input" id="editBrandName">
      </div>
      
      <div class="form-group">
        <label class="form-label">üë§ ËÅØÁµ°‰∫∫</label>
        <input type="text" class="form-input" id="editContactPerson">
      </div>
      
      <div class="form-group">
        <label class="form-label">üìû ËÅØÁµ°ÈõªË©±</label>
        <input type="text" class="form-input" id="editContactPhone">
      </div>
      
      <div class="form-group">
        <label class="form-label">üìù ÂÇôË®ª</label>
        <textarea class="form-input" id="editNote" rows="3"></textarea>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('editModal')">ÂèñÊ∂à</button>
        <button class="btn btn-primary" onclick="confirmEdit()">‚úì ÂÑ≤Â≠òËÆäÊõ¥</button>
      </div>
    </div>
  </div>
  
  <script>
    // ÊéàÊ¨äÁÆ°ÁêÜ‰∏≠ÂøÉ API
    const AUTH_API = "https://script.google.com/macros/s/AKfycbyDsD6V7cP239XOFvQ3mRRPILxQsBagt5UIFTJszkfsSf_1SXiDAzIav-F2dXPRU22X/exec";
    
    let allClients = [];
    let currentFilter = 'all';
    let selectedClient = null;
    
    // ËºâÂÖ•ÂÆ¢Êà∂Ë≥áÊñô
    async function loadClients() {
      showNotification('‚è≥ ËºâÂÖ•‰∏≠...', 'info', 1000);
      
      try {
        const res = await fetch(`${AUTH_API}?action=getAllClients&_t=${Date.now()}`);
        const data = await res.json();
        
        if (data.ok && data.clients) {
          allClients = data.clients;
          updateStats();
          displayClients();
          showNotification('‚úÖ Ë≥áÊñôÂ∑≤Êõ¥Êñ∞', 'success');
        } else {
          showNotification('‚ùå ËºâÂÖ•Â§±ÊïóÔºö' + (data.msg || 'Êú™Áü•ÈåØË™§'), 'error');
        }
      } catch (err) {
        showNotification('‚ùå ÈÄ£Á∑öÂ§±ÊïóÔºö' + err.message, 'error');
      }
    }
    
    // Êõ¥Êñ∞Áµ±Ë®àÊï∏Êìö
    function updateStats() {
      const total = allClients.length;
      const active = allClients.filter(c => c.status === 'ÂïüÁî®').length;
      const inactive = total - active;
      
      const monthlyRevenue = allClients
        .filter(c => c.status === 'ÂïüÁî®')
        .reduce((sum, c) => sum + (c.monthlyFee || 0), 0);
      
      document.getElementById('totalClients').textContent = total;
      document.getElementById('activeClients').textContent = active;
      document.getElementById('inactiveClients').textContent = inactive;
      document.getElementById('monthlyRevenue').textContent = `$${monthlyRevenue.toLocaleString()}`;
      
      // Ê™¢Êü•Âç≥Â∞áÂà∞Êúü
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const expiring = allClients.filter(c => {
        if (!c.expireDate || c.status !== 'ÂïüÁî®') return false;
        const expireDate = new Date(c.expireDate);
        const daysLeft = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
        return daysLeft >= 0 && daysLeft <= 7;
      });
      
      const alertDiv = document.getElementById('expiringAlert');
      if (expiring.length > 0) {
        alertDiv.style.display = 'block';
        alertDiv.className = 'alert warning';
        alertDiv.innerHTML = `
          <strong>‚ö†Ô∏è ÊèêÈÜíÔºöÊúâ ${expiring.length} ÂÄãÂÆ¢Êà∂Âç≥Â∞áÂà∞ÊúüÔºà7Â§©ÂÖßÔºâ</strong><br>
          ${expiring.slice(0, 3).map(c => {
            const expireDate = new Date(c.expireDate);
            const daysLeft = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
            return `‚Ä¢ ${c.brandName} (${c.websiteId}) - Ââ©È§ò ${daysLeft} Â§©`;
          }).join('<br>')}
          ${expiring.length > 3 ? `<br>...ÈÇÑÊúâ ${expiring.length - 3} ÂÄã` : ''}
        `;
      } else {
        alertDiv.style.display = 'none';
      }
    }
    
    // È°ØÁ§∫ÂÆ¢Êà∂ÂàóË°®
    function displayClients(filter = 'all', searchTerm = '') {
      const tableContainer = document.getElementById('tableContainer');
      
      let filtered = allClients;
      
      if (filter === 'active') {
        filtered = filtered.filter(c => c.status === 'ÂïüÁî®');
      } else if (filter === 'inactive') {
        filtered = filtered.filter(c => c.status === 'ÂÅúÁî®');
      } else if (filter === 'expiring') {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        filtered = filtered.filter(c => {
          if (!c.expireDate || c.status !== 'ÂïüÁî®') return false;
          const expireDate = new Date(c.expireDate);
          const daysLeft = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
          return daysLeft >= 0 && daysLeft <= 7;
        });
      } else if (filter === 'trial') {
        filtered = filtered.filter(c => c.plan === 'Ë©¶Áî®Êúü');
      }
      
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filtered = filtered.filter(c => 
          (c.brandName && c.brandName.toLowerCase().includes(term)) ||
          (c.websiteId && c.websiteId.toLowerCase().includes(term)) ||
          (c.contactPerson && c.contactPerson.toLowerCase().includes(term))
        );
      }
      
      if (filtered.length === 0) {
        tableContainer.innerHTML = '<div style="text-align:center; padding:40px; color:#9ca3af;">Êâæ‰∏çÂà∞Á¨¶ÂêàÊ¢ù‰ª∂ÁöÑÂÆ¢Êà∂</div>';
        return;
      }
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      tableContainer.innerHTML = `
        <div style="overflow-x:auto;">
        <table class="client-table">
          <thead>
            <tr>
              <th>Á∂≤Á´ôID</th>
              <th>ÂïÜÂÆ∂ÂêçÁ®±</th>
              <th>ÊñπÊ°à</th>
              <th>ÁãÄÊÖã</th>
              <th>Âà∞ÊúüÊó•Êúü</th>
              <th>Ââ©È§ò</th>
              <th>ÊúàË≤ª</th>
              <th>ËÅØÁµ°‰∫∫</th>
              <th style="text-align:center; min-width:200px;">Âø´ÈÄüÊìç‰Ωú</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(client => {
              let daysLeft = '-';
              let daysLeftDisplay = '-';
              
              if (client.expireDate) {
                const expireDate = new Date(client.expireDate);
                const days = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
                daysLeft = days;
                
                if (days < 0) {
                  daysLeftDisplay = `<span class="badge inactive">ÈÅéÊúü${Math.abs(days)}Â§©</span>`;
                } else if (days === 0) {
                  daysLeftDisplay = '<span class="badge inactive">‰ªäÂ§©Âà∞Êúü</span>';
                } else if (days <= 3) {
                  daysLeftDisplay = `<span class="badge inactive">${days}Â§©</span>`;
                } else if (days <= 7) {
                  daysLeftDisplay = `<span class="badge warning">${days}Â§©</span>`;
                } else {
                  daysLeftDisplay = `<span style="color:#6b7280">${days}Â§©</span>`;
                }
              }
              
              const isActive = client.status === 'ÂïüÁî®';
              
              return `
                <tr>
                  <td><strong>${client.websiteId || '-'}</strong></td>
                  <td>${client.brandName || '-'}</td>
                  <td>${client.plan || '-'}</td>
                  <td>
                    <span class="badge ${isActive ? 'active' : 'inactive'}">
                      ${client.status || '-'}
                    </span>
                  </td>
                  <td>${client.expireDate || '-'}</td>
                  <td>${daysLeftDisplay}</td>
                  <td style="font-weight:600; color:#f59e0b;">$${client.monthlyFee || 0}</td>
                  <td>
                    ${client.contactPerson || '-'}<br>
                    <small style="color:#9ca3af">${client.contactPhone || ''}</small>
                  </td>
                  <td style="text-align:center; white-space:nowrap;">
                    <button class="btn btn-success" onclick='openRenewModal(${JSON.stringify(client).replace(/'/g, "\\'")})'  title="Á∫åË≤ª">
                      üí∞ Á∫åË≤ª
                    </button>
                    <button class="btn btn-${isActive ? 'warning' : 'success'}" onclick="toggleStatus('${client.websiteId}')" title="${isActive ? 'ÂÅúÁî®' : 'ÂïüÁî®'}">
                      ${isActive ? 'üîí ÂÅúÁî®' : '‚úÖ ÂïüÁî®'}
                    </button>
                    <button class="btn btn-secondary" onclick='openEditModal(${JSON.stringify(client).replace(/'/g, "\\'")})'  title="Á∑®ËºØ">
                      ‚úèÔ∏è Á∑®ËºØ
                    </button>
                    <button class="btn btn-danger" onclick="deleteClient('${client.websiteId}', '${client.brandName}')" title="Âà™Èô§">
                      üóëÔ∏è Âà™Èô§
                    </button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        </div>
      `;
    }
    
    // ÊâìÈñãÁ∫åË≤ªÂΩàÁ™ó
    function openRenewModal(client) {
      selectedClient = client;
      document.getElementById('renewClientName').textContent = client.brandName;
      document.getElementById('renewClientId').textContent = `Á∂≤Á´ôID: ${client.websiteId}`;
      document.getElementById('renewCurrentExpire').value = client.expireDate || '-';
      document.getElementById('renewPlan').value = '';
      document.getElementById('renewNewExpire').value = '';
      document.getElementById('renewModal').classList.add('active');
    }
    
    // Á∫åË≤ªÊñπÊ°àËÆäÊõ¥ÊôÇË®àÁÆóÊñ∞Âà∞ÊúüÊó•
    document.addEventListener('DOMContentLoaded', () => {
      const renewPlanSelect = document.getElementById('renewPlan');
      if (renewPlanSelect) {
        renewPlanSelect.addEventListener('change', () => {
          const plan = renewPlanSelect.value;
          const currentExpire = document.getElementById('renewCurrentExpire').value;
          
          if (plan && currentExpire && currentExpire !== '-') {
            const expireDate = new Date(currentExpire);
            let newDate = new Date(expireDate);
            
            switch(plan) {
              case 'ÊúàÁπ≥':
                newDate.setDate(newDate.getDate() + 30);
                break;
              case 'Â≠£Áπ≥':
                newDate.setDate(newDate.getDate() + 90);
                break;
              case 'ÂçäÂπ¥Áπ≥':
                newDate.setDate(newDate.getDate() + 180);
                break;
              case 'Âπ¥Áπ≥':
                newDate.setDate(newDate.getDate() + 365);
                break;
            }
            
            const formatted = newDate.toISOString().split('T')[0];
            document.getElementById('renewNewExpire').value = formatted;
          }
        });
      }
    });
    
    // Á¢∫Ë™çÁ∫åË≤ª
    async function confirmRenew() {
      const plan = document.getElementById('renewPlan').value;
      
      if (!plan) {
        showNotification('‚ö†Ô∏è Ë´ãÈÅ∏ÊìáÁ∫åË≤ªÊñπÊ°à', 'error');
        return;
      }
      
      const confirmBtn = document.getElementById('confirmRenewBtn');
      confirmBtn.disabled = true;
      confirmBtn.textContent = '‚è≥ ËôïÁêÜ‰∏≠...';
      
      try {
        const res = await fetch(`${AUTH_API}?action=renewClient&websiteId=${selectedClient.websiteId}&plan=${plan}`);
        const data = await res.json();
        
        if (data.ok) {
          showNotification(`‚úÖ Á∫åË≤ªÊàêÂäüÔºÅÊñ∞Âà∞ÊúüÊó•Ôºö${data.data.newExpireDate}`, 'success');
          closeModal('renewModal');
          setTimeout(() => loadClients(), 500);
        } else {
          showNotification('‚ùå Á∫åË≤ªÂ§±ÊïóÔºö' + data.msg, 'error');
        }
      } catch (err) {
        showNotification('‚ùå ÈÄ£Á∑öÂ§±ÊïóÔºö' + err.message, 'error');
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = '‚úì Á¢∫Ë™çÁ∫åË≤ª';
      }
    }
    
    // ÂàáÊèõÁãÄÊÖã
    async function toggleStatus(websiteId) {
      const client = allClients.find(c => c.websiteId === websiteId);
      const currentStatus = client.status;
      const action = currentStatus === 'ÂïüÁî®' ? 'ÂÅúÁî®' : 'ÂïüÁî®';
      
      if (!confirm(`Á¢∫ÂÆöË¶Å${action}„Äå${client.brandName}„ÄçÂóéÔºü`)) {
        return;
      }
      
      try {
        const res = await fetch(`${AUTH_API}?action=toggleStatus&websiteId=${websiteId}`);
        const data = await res.json();
        
        if (data.ok) {
          showNotification(`‚úÖ Â∑≤${action}ÂÆ¢Êà∂`, 'success');
          setTimeout(() => loadClients(), 500);
        } else {
          showNotification('‚ùå Êìç‰ΩúÂ§±ÊïóÔºö' + data.msg, 'error');
        }
      } catch (err) {
        showNotification('‚ùå ÈÄ£Á∑öÂ§±ÊïóÔºö' + err.message, 'error');
      }
    }
    
    // Âà™Èô§ÂÆ¢Êà∂
    async function deleteClient(websiteId, brandName) {
      if (!confirm(`‚ö†Ô∏è Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${brandName}„ÄçÂóéÔºü\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©ÂéüÔºÅ\n\nÁ∂≤Á´ôID: ${websiteId}`)) {
        return;
      }
      
      // ‰∫åÊ¨°Á¢∫Ë™çÔºàÈò≤Ê≠¢Ë™§Âà™Ôºâ
      if (!confirm(`üî¥ ÊúÄÂæåÁ¢∫Ë™çÔºöÁúüÁöÑË¶ÅÂà™Èô§„Äå${brandName}„ÄçÂóéÔºü\n\nÂà™Èô§ÂæåÂ∞áÁÑ°Ê≥ïÊÅ¢Âæ©ÔºÅ`)) {
        return;
      }
      
      try {
        const res = await fetch(`${AUTH_API}?action=deleteClient&websiteId=${websiteId}`);
        const data = await res.json();
        
        if (data.ok) {
          showNotification(`‚úÖ Â∑≤Âà™Èô§ÂÆ¢Êà∂Ôºö${brandName}`, 'success');
          setTimeout(() => loadClients(), 500);
        } else {
          showNotification('‚ùå Âà™Èô§Â§±ÊïóÔºö' + data.msg, 'error');
        }
      } catch (err) {
        showNotification('‚ùå ÈÄ£Á∑öÂ§±ÊïóÔºö' + err.message, 'error');
      }
    }
    
    // ÊâìÈñãÁ∑®ËºØÂΩàÁ™ó
    function openEditModal(client) {
      selectedClient = client;
      document.getElementById('editWebsiteId').value = client.websiteId;
      document.getElementById('editBrandName').value = client.brandName || '';
      document.getElementById('editContactPerson').value = client.contactPerson || '';
      document.getElementById('editContactPhone').value = client.contactPhone || '';
      document.getElementById('editNote').value = client.note || '';
      document.getElementById('editModal').classList.add('active');
    }
    
    // Á¢∫Ë™çÁ∑®ËºØ
    async function confirmEdit() {
      const websiteId = document.getElementById('editWebsiteId').value;
      const brandName = document.getElementById('editBrandName').value;
      const contactPerson = document.getElementById('editContactPerson').value;
      const contactPhone = document.getElementById('editContactPhone').value;
      const note = document.getElementById('editNote').value;
      
      try {
        const params = new URLSearchParams({
          action: 'updateClient',
          websiteId: websiteId,
          brandName: brandName,
          contactPerson: contactPerson,
          contactPhone: contactPhone,
          note: note
        });
        
        const res = await fetch(`${AUTH_API}?${params}`);
        const data = await res.json();
        
        if (data.ok) {
          showNotification('‚úÖ ÂÆ¢Êà∂Ë≥áË®äÂ∑≤Êõ¥Êñ∞', 'success');
          closeModal('editModal');
          setTimeout(() => loadClients(), 500);
        } else {
          showNotification('‚ùå Êõ¥Êñ∞Â§±ÊïóÔºö' + data.msg, 'error');
        }
      } catch (err) {
        showNotification('‚ùå ÈÄ£Á∑öÂ§±ÊïóÔºö' + err.message, 'error');
      }
    }
    
    // ÈóúÈñâÂΩàÁ™ó
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    // È°ØÁ§∫ÈÄöÁü•
    function showNotification(message, type = 'success', duration = 3000) {
      // ÁßªÈô§ÁèæÊúâÈÄöÁü•
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      if (duration > 0) {
        setTimeout(() => {
          if (document.body.contains(notification)) {
            notification.remove();
          }
        }, duration);
      }
    }
    
    // ÊêúÂ∞ãÂäüËÉΩ
    const searchBox = document.getElementById('searchBox');
    searchBox.addEventListener('input', (e) => {
      displayClients(currentFilter, e.target.value);
    });
    
    // ÁØ©ÈÅ∏Ê®ôÁ±§
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFilter = tab.dataset.filter;
        displayClients(currentFilter, searchBox.value);
      });
    });
    
    // ÁØ©ÈÅ∏ÂáΩÊï∏Ôºà‰æõÁµ±Ë®àÂç°ÁâáÈªûÊìäÔºâ
    function filterClients(filter) {
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      const tab = document.querySelector(`.filter-tab[data-filter="${filter}"]`);
      if (tab) tab.classList.add('active');
      currentFilter = filter;
      displayClients(filter, searchBox.value);
    }
    
    // ÈªûÊìäÂΩàÁ™óÂ§ñÈÉ®ÈóúÈñâ
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
      }
    });
    
    // È†ÅÈù¢ËºâÂÖ•
    window.addEventListener('DOMContentLoaded', () => {
      loadClients();
    });
  </script>
</body>
</html>

