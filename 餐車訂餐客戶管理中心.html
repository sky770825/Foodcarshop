<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š é¤è»Šå®¢æˆ¶ç®¡ç†ä¸­å¿ƒ PRO</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      color: #1a1a1a;
    }
    
    .header {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      color: #1a1a1a;
      padding: 30px;
      border-radius: 16px;
      margin-bottom: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .header h1 {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .header p {
      color: #6b7280;
      font-size: 14px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .stat-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .stat-label {
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .stat-value {
      font-size: 36px;
      font-weight: 800;
      color: #1a1a1a;
      line-height: 1;
    }
    
    .stat-card.success .stat-value { color: #059669; }
    .stat-card.danger .stat-value { color: #dc2626; }
    .stat-card.warning .stat-value { color: #f59e0b; }
    .stat-card.primary .stat-value { color: #667eea; }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    
    .card-title {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .search-box {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 15px;
      margin-bottom: 16px;
      transition: all 0.2s;
    }
    
    .search-box:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .client-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    .client-table th {
      background: #f9fafb;
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      color: #374151;
      border-bottom: 2px solid #e5e7eb;
      white-space: nowrap;
      font-size: 13px;
    }
    
    .client-table td {
      padding: 12px 8px;
      border-bottom: 1px solid #f3f4f6;
      font-size: 13px;
    }
    
    .client-table tr:hover {
      background: #f9fafb;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .badge.active {
      background: #d1fae5;
      color: #065f46;
    }
    
    .badge.inactive {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .badge.warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin: 0 2px;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }
    
    .btn-success {
      background: #059669;
      color: white;
    }
    
    .btn-success:hover {
      background: #047857;
    }
    
    .btn-danger {
      background: #dc2626;
      color: white;
    }
    
    .btn-danger:hover {
      background: #b91c1c;
    }
    
    .btn-warning {
      background: #f59e0b;
      color: white;
    }
    
    .btn-warning:hover {
      background: #d97706;
    }
    
    .btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    
    .btn-secondary:hover {
      background: #e5e7eb;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    
    .loading-icon {
      font-size: 48px;
      animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    
    .alert {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      line-height: 1.6;
    }
    
    .alert.warning {
      background: #fef3c7;
      color: #92400e;
      border: 2px solid #fbbf24;
    }
    
    .alert.success {
      background: #d1fae5;
      color: #065f46;
      border: 2px solid #059669;
    }
    
    .filter-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .filter-tab {
      padding: 8px 16px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s;
    }
    
    .filter-tab:hover {
      border-color: #667eea;
    }
    
    .filter-tab.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .refresh-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .refresh-btn:hover {
      transform: scale(1.1);
    }
    
    /* å½ˆçª—æ¨£å¼ */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid #e5e7eb;
    }
    
    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }
    
    .close-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: none;
      background: #f3f4f6;
      color: #6b7280;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .close-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      font-size: 14px;
      color: #374151;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      margin-top: 24px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
    }
    
    .modal-footer .btn {
      flex: 1;
      padding: 12px;
      font-size: 14px;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
      z-index: 10000;
      animation: slideInRight 0.3s ease;
      max-width: 400px;
    }
    
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .notification.success {
      background: #059669;
      color: white;
    }
    
    .notification.error {
      background: #dc2626;
      color: white;
    }
    
    @media (max-width: 768px) {
      .client-table {
        font-size: 11px;
      }
      
      .client-table th,
      .client-table td {
        padding: 6px 4px;
      }
      
      .btn {
        padding: 4px 8px;
        font-size: 11px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <h1>ğŸ“Š é¤è»Šå®¢æˆ¶ç®¡ç†ä¸­å¿ƒ PRO</h1>
    <p>å®Œæ•´æ§åˆ¶ Â· å³æ™‚æ“ä½œ Â· æ•ˆç‡ç®¡ç†</p>
  </div>
  
  <!-- çµ±è¨ˆå¡ç‰‡ -->
  <div class="stats-grid" id="statsGrid">
    <div class="stat-card primary" onclick="filterClients('all')">
      <div class="stat-icon">ğŸ‘¥</div>
      <div class="stat-label">ç¸½å®¢æˆ¶æ•¸</div>
      <div class="stat-value" id="totalClients">-</div>
    </div>
    
    <div class="stat-card success" onclick="filterClients('active')">
      <div class="stat-icon">âœ…</div>
      <div class="stat-label">å•Ÿç”¨ä¸­</div>
      <div class="stat-value" id="activeClients">-</div>
    </div>
    
    <div class="stat-card danger" onclick="filterClients('inactive')">
      <div class="stat-icon">ğŸ”’</div>
      <div class="stat-label">å·²åœç”¨</div>
      <div class="stat-value" id="inactiveClients">-</div>
    </div>
    
    <div class="stat-card warning">
      <div class="stat-icon">ğŸ’°</div>
      <div class="stat-label">æœ¬æœˆæ”¶å…¥</div>
      <div class="stat-value" id="monthlyRevenue">-</div>
    </div>
  </div>
  
  <!-- å³å°‡åˆ°æœŸè­¦å‘Š -->
  <div id="expiringAlert" style="display: none;"></div>
  <div id="globalAlert" style="display: none;"></div>
  
  <!-- å®¢æˆ¶åˆ—è¡¨ -->
  <div class="card">
    <div class="card-title">
      <span>ğŸ“‹ å®¢æˆ¶åˆ—è¡¨</span>
      <button class="btn btn-primary" onclick="loadClients()" style="padding:8px 16px;">
        ğŸ”„ åˆ·æ–°è³‡æ–™
      </button>
    </div>
    
    <!-- æœå°‹æ¡† -->
    <input 
      type="text" 
      class="search-box" 
      id="searchBox" 
      placeholder="ğŸ” æœå°‹å®¢æˆ¶åç¨±ã€ç¶²ç«™IDã€è¯çµ¡äºº..."
    >
    
    <!-- ç¯©é¸æ¨™ç±¤ -->
    <div class="filter-tabs">
      <div class="filter-tab active" data-filter="all">å…¨éƒ¨å®¢æˆ¶</div>
      <div class="filter-tab" data-filter="active">âœ… å•Ÿç”¨ä¸­</div>
      <div class="filter-tab" data-filter="inactive">ğŸ”’ å·²åœç”¨</div>
      <div class="filter-tab" data-filter="expiring">âš ï¸ å³å°‡åˆ°æœŸ</div>
      <div class="filter-tab" data-filter="trial">ğŸ è©¦ç”¨æœŸ</div>
    </div>
    
    <!-- å®¢æˆ¶è¡¨æ ¼ -->
    <div id="tableContainer">
      <div class="loading">
        <div class="loading-icon">â³</div>
        <div>è¼‰å…¥ä¸­...</div>
      </div>
    </div>
  </div>
  
  <!-- çºŒè²»å½ˆçª— -->
  <div class="modal" id="renewModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">ğŸ’° å¿«é€ŸçºŒè²»</div>
        <button class="close-btn" onclick="closeModal('renewModal')">Ã—</button>
      </div>
      
      <div style="background:#f9fafb; padding:16px; border-radius:8px; margin-bottom:20px;">
        <div style="font-size:13px; color:#6b7280; margin-bottom:4px;">å®¢æˆ¶è³‡è¨Š</div>
        <div style="font-size:18px; font-weight:700;" id="renewClientName">-</div>
        <div style="font-size:13px; color:#9ca3af; margin-top:4px;" id="renewClientId">-</div>
      </div>
      
      <div class="form-group">
        <label class="form-label">ğŸ“… ç•¶å‰åˆ°æœŸæ—¥æœŸ</label>
        <input type="text" class="form-input" id="renewCurrentExpire" readonly style="background:#f3f4f6;">
      </div>
      
      <div class="form-group">
        <label class="form-label">ğŸ’³ çºŒè²»æ–¹æ¡ˆ <span style="color:#dc2626">*</span></label>
        <select class="form-select" id="renewPlan">
          <option value="">è«‹é¸æ“‡...</option>
          <option value="æœˆç¹³">æœˆç¹³ - 600å…ƒï¼ˆå»¶é•·30å¤©ï¼‰</option>
          <option value="å­£ç¹³">å­£ç¹³ - 1440å…ƒï¼ˆå»¶é•·90å¤©ï¼‰</option>
          <option value="åŠå¹´ç¹³">åŠå¹´ç¹³ - 2880å…ƒï¼ˆå»¶é•·180å¤©ï¼‰</option>
          <option value="å¹´ç¹³">å¹´ç¹³ - 5400å…ƒï¼ˆå»¶é•·365å¤©ï¼‰</option>
        </select>
      </div>
      
      <div class="form-group">
        <label class="form-label">ğŸ“… çºŒè²»å¾Œåˆ°æœŸæ—¥æœŸ</label>
        <input type="text" class="form-input" id="renewNewExpire" readonly style="background:#f9fafb; color:#059669; font-weight:600;">
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('renewModal')">å–æ¶ˆ</button>
        <button class="btn btn-success" onclick="confirmRenew()" id="confirmRenewBtn">âœ“ ç¢ºèªçºŒè²»</button>
      </div>
    </div>
  </div>
  
  <!-- ç·¨è¼¯å½ˆçª— -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">âœï¸ ç·¨è¼¯å®¢æˆ¶è³‡è¨Š</div>
        <button class="close-btn" onclick="closeModal('editModal')">Ã—</button>
      </div>
      
      <input type="hidden" id="editWebsiteId">
      
      <div class="form-group">
        <label class="form-label">ğŸª å•†å®¶åç¨±</label>
        <input type="text" class="form-input" id="editBrandName">
      </div>
      
      <div class="form-group">
        <label class="form-label">ğŸ‘¤ è¯çµ¡äºº</label>
        <input type="text" class="form-input" id="editContactPerson">
      </div>
      
      <div class="form-group">
        <label class="form-label">ğŸ“ è¯çµ¡é›»è©±</label>
        <input type="text" class="form-input" id="editContactPhone">
      </div>
      
      <div class="form-group">
        <label class="form-label">ğŸ“ å‚™è¨»</label>
        <textarea class="form-input" id="editNote" rows="3"></textarea>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('editModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="confirmEdit()">âœ“ å„²å­˜è®Šæ›´</button>
      </div>
    </div>
  </div>
  
  <script>
    // æˆæ¬Šç®¡ç†ä¸­å¿ƒ API
    const AUTH_API = "https://script.google.com/macros/s/AKfycbyDsD6V7cP239XOFvQ3mRRPILxQsBagt5UIFTJszkfsSf_1SXiDAzIav-F2dXPRU22X/exec";
    
    let allClients = [];
    let currentFilter = 'all';
    let selectedClient = null;
    
    // è¼‰å…¥å®¢æˆ¶è³‡æ–™
    async function loadClients() {
      showNotification('â³ è¼‰å…¥ä¸­...', 'info', 1000);
      
      try {
        const res = await fetch(`${AUTH_API}?action=getAllClients&_t=${Date.now()}`);
        const data = await res.json();
        
        if (data.ok && data.clients) {
          allClients = data.clients;
          updateStats();
          displayClients();
          showNotification('âœ… è³‡æ–™å·²æ›´æ–°', 'success');
        } else {
          showNotification('âŒ è¼‰å…¥å¤±æ•—ï¼š' + (data.msg || 'æœªçŸ¥éŒ¯èª¤'), 'error');
        }
      } catch (err) {
        showNotification('âŒ é€£ç·šå¤±æ•—ï¼š' + err.message, 'error');
      }
    }
    
    // æ›´æ–°çµ±è¨ˆæ•¸æ“š
    function updateStats() {
      const total = allClients.length;
      const active = allClients.filter(c => c.status === 'å•Ÿç”¨').length;
      const inactive = total - active;
      
      const monthlyRevenue = allClients
        .filter(c => c.status === 'å•Ÿç”¨')
        .reduce((sum, c) => sum + (c.monthlyFee || 0), 0);
      
      document.getElementById('totalClients').textContent = total;
      document.getElementById('activeClients').textContent = active;
      document.getElementById('inactiveClients').textContent = inactive;
      document.getElementById('monthlyRevenue').textContent = `$${monthlyRevenue.toLocaleString()}`;
      
      // æª¢æŸ¥å³å°‡åˆ°æœŸ
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const expiring = allClients.filter(c => {
        if (!c.expireDate || c.status !== 'å•Ÿç”¨') return false;
        const expireDate = new Date(c.expireDate);
        const daysLeft = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
        return daysLeft >= 0 && daysLeft <= 7;
      });
      
      const alertDiv = document.getElementById('expiringAlert');
      if (expiring.length > 0) {
        alertDiv.style.display = 'block';
        alertDiv.className = 'alert warning';
        alertDiv.innerHTML = `
          <strong>âš ï¸ æé†’ï¼šæœ‰ ${expiring.length} å€‹å®¢æˆ¶å³å°‡åˆ°æœŸï¼ˆ7å¤©å…§ï¼‰</strong><br>
          ${expiring.slice(0, 3).map(c => {
            const expireDate = new Date(c.expireDate);
            const daysLeft = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
            return `â€¢ ${c.brandName} (${c.websiteId}) - å‰©é¤˜ ${daysLeft} å¤©`;
          }).join('<br>')}
          ${expiring.length > 3 ? `<br>...é‚„æœ‰ ${expiring.length - 3} å€‹` : ''}
        `;
      } else {
        alertDiv.style.display = 'none';
      }
    }
    
    // é¡¯ç¤ºå®¢æˆ¶åˆ—è¡¨
    function displayClients(filter = 'all', searchTerm = '') {
      const tableContainer = document.getElementById('tableContainer');
      
      let filtered = allClients;
      
      if (filter === 'active') {
        filtered = filtered.filter(c => c.status === 'å•Ÿç”¨');
      } else if (filter === 'inactive') {
        filtered = filtered.filter(c => c.status === 'åœç”¨');
      } else if (filter === 'expiring') {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        filtered = filtered.filter(c => {
          if (!c.expireDate || c.status !== 'å•Ÿç”¨') return false;
          const expireDate = new Date(c.expireDate);
          const daysLeft = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
          return daysLeft >= 0 && daysLeft <= 7;
        });
      } else if (filter === 'trial') {
        filtered = filtered.filter(c => c.plan === 'è©¦ç”¨æœŸ');
      }
      
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filtered = filtered.filter(c => 
          (c.brandName && c.brandName.toLowerCase().includes(term)) ||
          (c.websiteId && c.websiteId.toLowerCase().includes(term)) ||
          (c.contactPerson && c.contactPerson.toLowerCase().includes(term))
        );
      }
      
      if (filtered.length === 0) {
        tableContainer.innerHTML = '<div style="text-align:center; padding:40px; color:#9ca3af;">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„å®¢æˆ¶</div>';
        return;
      }
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      tableContainer.innerHTML = `
        <div style="overflow-x:auto;">
        <table class="client-table">
          <thead>
            <tr>
              <th>ç¶²ç«™ID</th>
              <th>å•†å®¶åç¨±</th>
              <th>æ–¹æ¡ˆ</th>
              <th>ç‹€æ…‹</th>
              <th>åˆ°æœŸæ—¥æœŸ</th>
              <th>å‰©é¤˜</th>
              <th>æœˆè²»</th>
              <th>è¯çµ¡äºº</th>
              <th style="text-align:center; min-width:200px;">å¿«é€Ÿæ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            ${filtered.map(client => {
              let daysLeft = '-';
              let daysLeftDisplay = '-';
              
              if (client.expireDate) {
                const expireDate = new Date(client.expireDate);
                const days = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
                daysLeft = days;
                
                if (days < 0) {
                  daysLeftDisplay = `<span class="badge inactive">éæœŸ${Math.abs(days)}å¤©</span>`;
                } else if (days === 0) {
                  daysLeftDisplay = '<span class="badge inactive">ä»Šå¤©åˆ°æœŸ</span>';
                } else if (days <= 3) {
                  daysLeftDisplay = `<span class="badge inactive">${days}å¤©</span>`;
                } else if (days <= 7) {
                  daysLeftDisplay = `<span class="badge warning">${days}å¤©</span>`;
                } else {
                  daysLeftDisplay = `<span style="color:#6b7280">${days}å¤©</span>`;
                }
              }
              
              const isActive = client.status === 'å•Ÿç”¨';
              
              return `
                <tr>
                  <td><strong>${client.websiteId || '-'}</strong></td>
                  <td>${client.brandName || '-'}</td>
                  <td>${client.plan || '-'}</td>
                  <td>
                    <span class="badge ${isActive ? 'active' : 'inactive'}">
                      ${client.status || '-'}
                    </span>
                  </td>
                  <td>${client.expireDate || '-'}</td>
                  <td>${daysLeftDisplay}</td>
                  <td style="font-weight:600; color:#f59e0b;">$${client.monthlyFee || 0}</td>
                  <td>
                    ${client.contactPerson || '-'}<br>
                    <small style="color:#9ca3af">${client.contactPhone || ''}</small>
                  </td>
                  <td style="text-align:center; white-space:nowrap;">
                    <button class="btn btn-success" onclick='openRenewModal(${JSON.stringify(client).replace(/'/g, "\\'")})'  title="çºŒè²»">
                      ğŸ’° çºŒè²»
                    </button>
                    <button class="btn btn-${isActive ? 'warning' : 'success'}" onclick="toggleStatus('${client.websiteId}')" title="${isActive ? 'åœç”¨' : 'å•Ÿç”¨'}">
                      ${isActive ? 'ğŸ”’ åœç”¨' : 'âœ… å•Ÿç”¨'}
                    </button>
                    <button class="btn btn-secondary" onclick='openEditModal(${JSON.stringify(client).replace(/'/g, "\\'")})'  title="ç·¨è¼¯">
                      âœï¸ ç·¨è¼¯
                    </button>
                    <button class="btn btn-danger" onclick="deleteClient('${client.websiteId}', '${client.brandName}')" title="åˆªé™¤">
                      ğŸ—‘ï¸ åˆªé™¤
                    </button>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        </div>
      `;
    }
    
    // æ‰“é–‹çºŒè²»å½ˆçª—
    function openRenewModal(client) {
      selectedClient = client;
      document.getElementById('renewClientName').textContent = client.brandName;
      document.getElementById('renewClientId').textContent = `ç¶²ç«™ID: ${client.websiteId}`;
      document.getElementById('renewCurrentExpire').value = client.expireDate || '-';
      document.getElementById('renewPlan').value = '';
      document.getElementById('renewNewExpire').value = '';
      document.getElementById('renewModal').classList.add('active');
    }
    
    // çºŒè²»æ–¹æ¡ˆè®Šæ›´æ™‚è¨ˆç®—æ–°åˆ°æœŸæ—¥
    document.addEventListener('DOMContentLoaded', () => {
      const renewPlanSelect = document.getElementById('renewPlan');
      if (renewPlanSelect) {
        renewPlanSelect.addEventListener('change', () => {
          const plan = renewPlanSelect.value;
          const currentExpire = document.getElementById('renewCurrentExpire').value;
          
          if (plan && currentExpire && currentExpire !== '-') {
            const expireDate = new Date(currentExpire);
            let newDate = new Date(expireDate);
            
            switch(plan) {
              case 'æœˆç¹³':
                newDate.setDate(newDate.getDate() + 30);
                break;
              case 'å­£ç¹³':
                newDate.setDate(newDate.getDate() + 90);
                break;
              case 'åŠå¹´ç¹³':
                newDate.setDate(newDate.getDate() + 180);
                break;
              case 'å¹´ç¹³':
                newDate.setDate(newDate.getDate() + 365);
                break;
            }
            
            const formatted = newDate.toISOString().split('T')[0];
            document.getElementById('renewNewExpire').value = formatted;
          }
        });
      }
    });
    
    // ç¢ºèªçºŒè²»
    async function confirmRenew() {
      const plan = document.getElementById('renewPlan').value;
      
      if (!plan) {
        showNotification('âš ï¸ è«‹é¸æ“‡çºŒè²»æ–¹æ¡ˆ', 'error');
        return;
      }
      
      const confirmBtn = document.getElementById('confirmRenewBtn');
      confirmBtn.disabled = true;
      confirmBtn.textContent = 'â³ è™•ç†ä¸­...';
      
      try {
        const res = await fetch(`${AUTH_API}?action=renewClient&websiteId=${selectedClient.websiteId}&plan=${plan}`);
        const data = await res.json();
        
        if (data.ok) {
          showNotification(`âœ… çºŒè²»æˆåŠŸï¼æ–°åˆ°æœŸæ—¥ï¼š${data.data.newExpireDate}`, 'success');
          closeModal('renewModal');
          setTimeout(() => loadClients(), 500);
        } else {
          showNotification('âŒ çºŒè²»å¤±æ•—ï¼š' + data.msg, 'error');
        }
      } catch (err) {
        showNotification('âŒ é€£ç·šå¤±æ•—ï¼š' + err.message, 'error');
      } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'âœ“ ç¢ºèªçºŒè²»';
      }
    }
    
    // åˆ‡æ›ç‹€æ…‹
    async function toggleStatus(websiteId) {
      const client = allClients.find(c => c.websiteId === websiteId);
      const currentStatus = client.status;
      const action = currentStatus === 'å•Ÿç”¨' ? 'åœç”¨' : 'å•Ÿç”¨';
      
      if (!confirm(`ç¢ºå®šè¦${action}ã€Œ${client.brandName}ã€å—ï¼Ÿ`)) {
        return;
      }
      
      try {
        const res = await fetch(`${AUTH_API}?action=toggleStatus&websiteId=${websiteId}`);
        const data = await res.json();
        
        if (data.ok) {
          showNotification(`âœ… å·²${action}å®¢æˆ¶`, 'success');
          setTimeout(() => loadClients(), 500);
        } else {
          showNotification('âŒ æ“ä½œå¤±æ•—ï¼š' + data.msg, 'error');
        }
      } catch (err) {
        showNotification('âŒ é€£ç·šå¤±æ•—ï¼š' + err.message, 'error');
      }
    }
    
    // åˆªé™¤å®¢æˆ¶
    async function deleteClient(websiteId, brandName) {
      if (!confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤ã€Œ${brandName}ã€å—ï¼Ÿ\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼\n\nç¶²ç«™ID: ${websiteId}`)) {
        return;
      }
      
      // äºŒæ¬¡ç¢ºèªï¼ˆé˜²æ­¢èª¤åˆªï¼‰
      if (!confirm(`ğŸ”´ æœ€å¾Œç¢ºèªï¼šçœŸçš„è¦åˆªé™¤ã€Œ${brandName}ã€å—ï¼Ÿ\n\nåˆªé™¤å¾Œå°‡ç„¡æ³•æ¢å¾©ï¼`)) {
        return;
      }
      
      try {
        const res = await fetch(`${AUTH_API}?action=deleteClient&websiteId=${websiteId}`);
        const data = await res.json();
        
        if (data.ok) {
          showNotification(`âœ… å·²åˆªé™¤å®¢æˆ¶ï¼š${brandName}`, 'success');
          setTimeout(() => loadClients(), 500);
        } else {
          showNotification('âŒ åˆªé™¤å¤±æ•—ï¼š' + data.msg, 'error');
        }
      } catch (err) {
        showNotification('âŒ é€£ç·šå¤±æ•—ï¼š' + err.message, 'error');
      }
    }
    
    // æ‰“é–‹ç·¨è¼¯å½ˆçª—
    function openEditModal(client) {
      selectedClient = client;
      document.getElementById('editWebsiteId').value = client.websiteId;
      document.getElementById('editBrandName').value = client.brandName || '';
      document.getElementById('editContactPerson').value = client.contactPerson || '';
      document.getElementById('editContactPhone').value = client.contactPhone || '';
      document.getElementById('editNote').value = client.note || '';
      document.getElementById('editModal').classList.add('active');
    }
    
    // ç¢ºèªç·¨è¼¯
    async function confirmEdit() {
      const websiteId = document.getElementById('editWebsiteId').value;
      const brandName = document.getElementById('editBrandName').value;
      const contactPerson = document.getElementById('editContactPerson').value;
      const contactPhone = document.getElementById('editContactPhone').value;
      const note = document.getElementById('editNote').value;
      
      try {
        const params = new URLSearchParams({
          action: 'updateClient',
          websiteId: websiteId,
          brandName: brandName,
          contactPerson: contactPerson,
          contactPhone: contactPhone,
          note: note
        });
        
        const res = await fetch(`${AUTH_API}?${params}`);
        const data = await res.json();
        
        if (data.ok) {
          showNotification('âœ… å®¢æˆ¶è³‡è¨Šå·²æ›´æ–°', 'success');
          closeModal('editModal');
          setTimeout(() => loadClients(), 500);
        } else {
          showNotification('âŒ æ›´æ–°å¤±æ•—ï¼š' + data.msg, 'error');
        }
      } catch (err) {
        showNotification('âŒ é€£ç·šå¤±æ•—ï¼š' + err.message, 'error');
      }
    }
    
    // é—œé–‰å½ˆçª—
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    // é¡¯ç¤ºé€šçŸ¥
    function showNotification(message, type = 'success', duration = 3000) {
      // ç§»é™¤ç¾æœ‰é€šçŸ¥
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();
      
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      if (duration > 0) {
        setTimeout(() => {
          if (document.body.contains(notification)) {
            notification.remove();
          }
        }, duration);
      }
    }
    
    // æœå°‹åŠŸèƒ½
    const searchBox = document.getElementById('searchBox');
    searchBox.addEventListener('input', (e) => {
      displayClients(currentFilter, e.target.value);
    });
    
    // ç¯©é¸æ¨™ç±¤
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFilter = tab.dataset.filter;
        displayClients(currentFilter, searchBox.value);
      });
    });
    
    // ç¯©é¸å‡½æ•¸ï¼ˆä¾›çµ±è¨ˆå¡ç‰‡é»æ“Šï¼‰
    function filterClients(filter) {
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      const tab = document.querySelector(`.filter-tab[data-filter="${filter}"]`);
      if (tab) tab.classList.add('active');
      currentFilter = filter;
      displayClients(filter, searchBox.value);
    }
    
    // é»æ“Šå½ˆçª—å¤–éƒ¨é—œé–‰
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        e.target.classList.remove('active');
      }
    });
    
    // é é¢è¼‰å…¥
    window.addEventListener('DOMContentLoaded', () => {
      loadClients();
    });
  </script>
</body>
</html>

