# 🔐 授權管理系統設置教學

## 📋 系統架構

```
您（管理員）
    ↓
【授權管理中心 Sheets】 ← 集中管理所有客戶
    ↓ (授權檢查 API)
客戶A的網站 (WEBSITE_ID: WEB001) → 客戶A的訂單 Sheets
客戶B的網站 (WEBSITE_ID: WEB002) → 客戶B的訂單 Sheets
客戶C的網站 (WEBSITE_ID: WEB003) → 客戶C的訂單 Sheets
```

---

## 步驟 1：建立授權管理中心 Sheets

### 1.1 建立新的 Google Sheets

1. 開啟 Google Sheets：https://sheets.google.com
2. 建立新試算表
3. 命名為：**「客戶授權管理中心」**

### 1.2 建立「授權清單」工作表

在第一個工作表中，建立以下表格結構：

| 網站ID  | 商家名稱      | 到期日期    | 狀態   | 備註          |
|---------|--------------|------------|--------|---------------|
| WEB001  | 極品鹽水雞    | 2025-11-12 | 啟用   | 月付500元     |
| WEB002  | 王記鹽酥雞    | 2025-12-31 | 啟用   | 季付1500元    |
| WEB003  | 李家滷味      | 2025-10-01 | 停用   | 已到期        |

**欄位說明：**
- **網站ID**：每個客戶的唯一識別碼（例如：WEB001, WEB002...）
- **商家名稱**：客戶的店名
- **到期日期**：訂閱到期日（格式：YYYY-MM-DD）
- **狀態**：只能填「啟用」或「停用」
- **備註**：記錄付費方案、備註等

---

## 步驟 2：設置授權 API

### 2.1 開啟 Apps Script

在「授權管理中心」Sheets 中：
1. 點擊上方選單：**擴充功能 → Apps Script**
2. 刪除原有的範例代碼
3. 將 `授權管理中心_Apps_Script.js` 的內容完整複製貼上
4. 點擊 **儲存**（💾 圖示）

### 2.2 部署為網路應用程式

1. 點擊右上角 **部署 → 新增部署作業**
2. 選擇類型：**網路應用程式**
3. 設定：
   - **說明**：授權管理 API
   - **執行身分**：我
   - **具有存取權的使用者**：所有人
4. 點擊 **部署**
5. **複製網址**（這就是您的 `AUTH_API`）

範例網址格式：
```
https://script.google.com/macros/s/AKfycbxxx.../exec
```

⚠️ **重要**：將這個網址記下來，稍後會用到！

---

## 步驟 3：設置客戶網站

### 3.1 修改客戶的 HTML 檔案

在每個客戶的 `cheenken.html` 中，找到第 989-990 行：

```javascript
const WEBSITE_ID = "WEB001"; // ⚠️ 每個客戶的網站ID不同，請勿修改
const AUTH_API = "YOUR_AUTH_API_URL_HERE"; // 授權管理中心 API 網址
```

**修改為：**

```javascript
const WEBSITE_ID = "WEB001"; // ← 客戶A改成 WEB001
const AUTH_API = "https://script.google.com/macros/s/AKfycbxxx.../exec"; // ← 貼上您的授權 API 網址
```

> **注意**：
> - 每個客戶的 `WEBSITE_ID` 都要不同
> - `AUTH_API` 所有客戶都用同一個（您的授權管理中心 API）

### 3.2 客戶對應表

記錄每個客戶的資訊：

| 客戶名稱    | WEBSITE_ID | HTML檔案        | 到期日期    |
|------------|------------|----------------|------------|
| 極品鹽水雞  | WEB001     | cheenken_A.html | 2025-11-12 |
| 王記鹽酥雞  | WEB002     | cheenken_B.html | 2025-12-31 |
| 李家滷味    | WEB003     | cheenken_C.html | 2026-01-15 |

---

## 步驟 4：測試系統

### 4.1 測試授權正常

1. 在「授權清單」中設定一個測試客戶：
   - 網站ID：WEB001
   - 狀態：啟用
   - 到期日期：設定為未來日期（例如：2026-12-31）

2. 開啟該客戶的網站
3. 應該正常顯示點餐介面

### 4.2 測試授權到期

1. 將該客戶的「到期日期」改為過去日期（例如：2024-01-01）
2. 重新整理客戶網站
3. 應該顯示 🔒 **授權已到期** 的頁面

### 4.3 測試手動停用

1. 將「狀態」改為：**停用**
2. 重新整理客戶網站
3. 應該顯示 🔒 **授權已停用** 的頁面

### 4.4 測試到期警告

1. 將「到期日期」改為 7 天內的日期
2. 「狀態」設為：**啟用**
3. 重新整理網站
4. 應該在頂部顯示黃色警告條：
   > ⚠️ 訂閱即將到期（剩餘 X 天，YYYY-MM-DD），請盡快續費以免影響使用

---

## 🎯 日常使用

### 新增客戶

1. 在「授權清單」新增一行：
   ```
   | WEB004 | 新客戶名稱 | 2026-01-01 | 啟用 | 月付500元 |
   ```

2. 複製一份 `cheenken.html` 給新客戶

3. 修改新客戶檔案中的 `WEBSITE_ID`：
   ```javascript
   const WEBSITE_ID = "WEB004";
   ```

4. 完成！

### 客戶續費

只需在「授權清單」中：
- 更新「到期日期」為新的到期日
- 確保「狀態」為「啟用」
- 客戶重新整理網站後即可繼續使用

### 停用客戶（到期/欠費）

只需將「狀態」改為：**停用**

或讓「到期日期」自然過期即可

### 臨時恢復

將「狀態」改回：**啟用**

---

## 📊 管理技巧

### 快速篩選即將到期的客戶

在「授權清單」中使用 Google Sheets 的篩選功能：
1. 選取資料範圍
2. 點擊 **資料 → 建立篩選器**
3. 篩選「到期日期」在 7 天內的客戶

### 自動提醒（進階）

可以在 Apps Script 中加入定時觸發器：
- 每天檢查快到期的客戶
- 自動發送 Email 或 LINE 通知

### 統計報表

使用 Google Sheets 的公式統計：
- 總客戶數：`=COUNTA(A2:A)`
- 啟用客戶：`=COUNTIF(D2:D, "啟用")`
- 本月到期：`=COUNTIFS(C2:C, ">=2025-11-01", C2:C, "<=2025-11-30")`

---

## ⚠️ 注意事項

### 安全性

1. **不要公開分享** 授權管理中心的 Sheets 連結
2. **定期備份** 授權清單資料
3. 每個客戶的 `WEBSITE_ID` 要唯一，不可重複

### 維護

1. **定期檢查** 到期日期，避免客戶突然被鎖
2. **做好記錄**：誰續費、續費到何時
3. 如果修改 API 代碼，記得 **重新部署**

### 降級處理

如果授權 API 連線失敗：
- 系統會自動允許客戶繼續使用（避免誤鎖）
- 請檢查 API 網址是否正確
- 檢查授權管理中心 Sheets 的共用權限

---

## 🆘 常見問題

### Q: 客戶說網站被鎖但明明還沒到期？

**A:** 檢查：
1. 授權清單中的「狀態」是否為「啟用」
2. 「到期日期」格式是否正確（YYYY-MM-DD）
3. 客戶的 HTML 檔案中 `WEBSITE_ID` 是否正確

### Q: 修改到期日期後客戶還是被鎖？

**A:** 請客戶重新整理頁面（Ctrl+F5 強制重新載入）

### Q: 如何臨時關閉授權檢查？

**A:** 在客戶的 HTML 檔案中，將 `AUTH_API` 改為：
```javascript
const AUTH_API = "YOUR_AUTH_API_URL_HERE"; // 這樣會跳過授權檢查
```

### Q: 可以批次修改多個客戶嗎？

**A:** 可以！在「授權清單」中直接用複製貼上、拖曳等方式批次修改

---

## 📞 技術支援

如有問題，請聯繫：
- LINE: https://lin.ee/YyXagFg
- 系統開發：快閃餐車小幫手

---

**版本**：v1.0  
**更新日期**：2025-10-12

